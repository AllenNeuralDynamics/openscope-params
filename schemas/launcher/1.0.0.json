{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.invalid/openscope-params/schemas/launcher/1.0.0.json",
  "title": "OpenScope Experimental Launcher Params (Base)",
  "description": "Top-level schema for OpenScope launcher parameter files. This schema is intentionally permissive (additionalProperties=true) while providing structured validation and documentation for common keys and pipeline entry formats.",
  "type": "object",
  "additionalProperties": true,
  "$defs": {
    "pipeline_entry": {
      "oneOf": [
        {"type": "string"},
        {"$ref": "#/$defs/pipeline_entry_object"},
        {"$ref": "#/$defs/legacy_repo_module_entry"}
      ]
    },
    "pipeline_entry_object": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "module_type": {
          "type": "string",
          "enum": ["launcher_module", "script_module"],
          "description": "How to execute this pipeline entry. 'launcher_module' refers to a Python module implemented by the launcher; 'script_module' runs a repository script function with arguments."
        },
        "module_path": {
          "type": "string",
          "description": "Identifier for the module to run. For 'launcher_module' this is the module name (e.g. 'metadata_subject_fetch'); for 'script_module' this is typically a repository-relative path to a Python file."
        },
        "module_parameters": {
          "type": "object",
          "additionalProperties": true,
          "description": "Arguments passed to the module. For known launcher modules this is validated against a module-specific schema."
        }
      },
      "required": ["module_path"],
      "allOf": [
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "metadata_subject_fetch"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/metadata_subject_fetch/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "metadata_procedures_fetch"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/metadata_procedures_fetch/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "metadata_project_validator"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/metadata_project_validator/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "metadata_protocol_validator"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/metadata_protocol_validator/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "experiment_notes_editor"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/experiment_notes_editor/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "experiment_notes_finalize"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/experiment_notes_finalize/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "zmq_ready_publisher"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/zmq_ready_publisher/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "zmq_ready_waiter"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/zmq_ready_waiter/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "session_archiver"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/session_archiver/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "session_creator"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/session_creator/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "stimulus_table_predictive_processing"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/stimulus_table_predictive_processing/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "session_enhancer_bonsai"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/session_enhancer_bonsai/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "session_enhancer_predictive_processing"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/session_enhancer_predictive_processing/1.0.0.json"}
            }
          }
        },
        {
          "if": {
            "properties": {
              "module_type": {"const": "launcher_module"},
              "module_path": {"const": "session_enhancer_slap2"}
            }
          },
          "then": {
            "properties": {
              "module_parameters": {"$ref": "modules/session_enhancer_slap2/1.0.0.json"}
            }
          }
        }
      ]
    },
    "legacy_repo_module_entry": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "type": {"const": "repo_module", "description": "Legacy pipeline entry type."},
        "repo_relative_path": {"type": "string", "description": "Path within the checked-out repository containing the callable."},
        "function": {"type": "string", "description": "Function name to invoke from the repo module."},
        "kwargs": {"type": "object", "additionalProperties": true, "description": "Keyword arguments passed to the function."}
      },
      "required": ["type", "repo_relative_path"]
    }
  },
  "properties": {
    "$schema": {"type": "string", "description": "JSON Schema identifier. Typically a relative path to the schema within this repo."},
    "launcher_version": {"type": "string", "description": "SemVer constraint for the launcher version expected to consume this params file (e.g. '>=0.2,<0.3')."},
    "launcher": {"type": "string", "enum": ["base", "bonsai", "python", "matlab"], "description": "Which launcher implementation should be used."},

    "subject_id": {"type": ["string", "integer"], "description": "Subject identifier used for naming and metadata lookup (often the mouse ID)."},
    "user_id": {"type": "string", "description": "Operator/user identifier recorded alongside the session."},

    "output_root_folder": {"type": "string", "description": "Root directory under which session folders are created."},
    "output_session_folder": {"type": "string", "description": "Full path to the current session folder (often set/derived by the launcher)."},
    "session_uuid": {"type": "string", "description": "Session UUID. Often generated by the launcher and used for naming/archival."},

    "rig_id": {"type": "string", "description": "Rig identifier (used to select rig-specific configuration parameters)."},
    "rig_config_path": {"type": "string", "description": "Path to a rig configuration file if the launcher supports it."},

    "repository_url": {"type": "string", "description": "Git URL for the experiment repository that contains scripts/assets invoked by this session."},
    "repository_commit_hash": {"type": "string", "description": "Commit hash of the repository to use (for reproducibility)."},
    "local_repository_path": {"type": "string", "description": "Local path where the repository is/will be checked out."},

    "script_path": {"type": "string", "description": "Entry script to run (launcher-specific; e.g. a Bonsai workflow or executable)."},
    "script_parameters": {"type": "object", "additionalProperties": true, "description": "Key/value parameters passed into the script (launcher-specific)."},

    "pre_acquisition_pipeline": {"type": "array", "items": {"$ref": "#/$defs/pipeline_entry"}, "description": "Pipeline entries run before acquisition starts (metadata checks, notes prompts, CSV generation, etc.)."},
    "post_acquisition_pipeline": {"type": "array", "items": {"$ref": "#/$defs/pipeline_entry"}, "description": "Pipeline entries run after acquisition completes (archiving, enhancement, final prompts, etc.)."},

    "metadata_service_base_url": {"type": "string", "description": "Base URL for the metadata service (if used)."},
    "metadata_service_timeout": {"type": "number", "minimum": 0, "description": "Timeout in seconds for metadata service requests."},
    "metadata_subject_id": {"type": ["string", "integer"], "description": "Subject identifier to query in the metadata service."},
    "metadata_mouse_id": {"type": ["string", "integer"], "description": "Mouse identifier (if distinct from subject_id) for metadata lookup."},
    "metadata_procedures_timeout": {"type": "number", "minimum": 0, "description": "Timeout in seconds for fetching procedures from the metadata service."},
    "metadata_project_name": {"type": "string", "description": "Expected project name; used by project validator modules."},
    "metadata_project_prompt": {"type": "string", "description": "Prompt text shown when project validation needs operator confirmation."},
    "metadata_protocol_name": {"type": "string", "description": "Expected protocol name; used by protocol validator modules."},
    "metadata_protocol_prompt": {"type": "string", "description": "Prompt text shown when protocol validation needs operator confirmation."},

    "experiment_notes_filename": {"type": "string", "description": "Relative path (inside the session folder) where experiment notes are stored."},
    "experiment_notes_encoding": {"type": "string", "description": "Text encoding used when reading/writing experiment notes (e.g. 'utf-8')."},
    "experiment_notes_launch_editor": {"type": "boolean", "description": "If true, launch an external editor for notes during the notes editor module."},
    "experiment_notes_editor_command": {"oneOf": [{"type": "string"}, {"type": "array", "items": {"type": "string"}}]},
    "experiment_notes_editor_args": {"oneOf": [{"type": "string"}, {"type": "array", "items": {"type": "string"}}]},
    "experiment_notes_preview": {"type": "boolean", "description": "If true, print a preview of the notes to the console."},
    "experiment_notes_preview_limit": {"type": "integer", "minimum": 0, "description": "Maximum number of characters/lines to preview (module-specific)."},
    "experiment_notes_confirm_prompt": {"type": "string", "description": "Prompt text used to confirm notes are saved/final before completing a stage."},

    "zmq_ready_publisher_wait": {"type": "number", "minimum": 0, "description": "Seconds to wait before publishing 'ready' (allows subscribers to connect)."},
    "zmq_ready_waiter_timeout": {"type": "number", "minimum": 0, "description": "Seconds to wait for a 'ready' message before failing."},

    "network_dir": {"type": "string", "description": "Target network archive directory for session files."},
    "backup_dir": {"type": "string", "description": "Local backup directory used during/after archiving."},
    "manifest_path": {"type": "string"},
    "include_patterns": {"oneOf": [{"type": "string"}, {"type": "array", "items": {"type": "string"}}]},
    "exclude_patterns": {"oneOf": [{"type": "string"}, {"type": "array", "items": {"type": "string"}}]},
    "checksum_algo": {"type": "string", "description": "Checksum algorithm to use when verifying copied files (module-specific)."},
    "dry_run": {"type": "boolean", "description": "If true, do not actually copy/delete anything; just log actions."},
    "skip_completed": {"type": "boolean", "description": "If true, skip files that appear to have been already archived."},
    "max_retries": {"type": "integer", "minimum": 0, "description": "Maximum number of retries for failed copy/verify operations."},
    "remove_empty_dirs": {"type": "boolean", "description": "If true, remove empty directories from the source after archiving."},

    "session_type": {"type": "string", "enum": ["Parent", "Branch"]},
    "targeted_structure": {"type": "string"},
    "fov_coordinate_ml": {"type": "number"},
    "fov_coordinate_ap": {"type": "number"},
    "fov_coordinate_unit": {"type": "string"},
    "fov_reference": {"type": "string"},
    "magnification": {"type": "string"},
    "fov_scale_factor": {"type": "number"},

    "session_sync_role": {"type": "string", "enum": ["master", "slave"], "description": "Role in the session synchronization protocol."},
    "session_sync_port": {"type": "integer", "minimum": 1, "maximum": 65535},
    "session_sync_expected_slaves": {"type": "integer", "minimum": 0},
    "session_sync_bind_host": {"type": "string"},
    "session_sync_master_host": {"type": "string"},
    "session_sync_node_name": {"type": "string"},
    "session_sync_timeout_sec": {"type": "number", "minimum": 0},
    "session_sync_ack_timeout_sec": {"type": "number", "minimum": 0},
    "session_sync_retry_delay_sec": {"type": "number", "minimum": 0},
    "session_sync_key_param": {"type": "string"},
    "session_sync_session_key": {}
  },
  "required": ["subject_id", "user_id"],
  "$comment": "Permissive schema: additionalProperties=true to avoid coupling to module-specific keys."
}
